genrule(
    name = "build_python",
    srcs = glob(["**/**"]) + [
        "@local_config_cc//:toolchain",
    ],
    outs = [
        "bin/2to3",
        "bin/2to3-3.9",
        "bin/idle3",
        "bin/idle3.9",
        "bin/pip3",
        "bin/pip3.9",
        "bin/pydoc3",
        "bin/pydoc3.9",
        "bin/python3",
        "bin/python3-config",
        "bin/python3.9",
        "bin/python3.9-config",
        #
        "lib/libpython3.9.a",
        "lib/pkgconfig",
        "lib/python3.9",
        #
        "include/python3.9/abstract.h",
        "include/python3.9/asdl.h",
        "include/python3.9/ast.h",
        "include/python3.9/bitset.h",
        "include/python3.9/bltinmodule.h",
        "include/python3.9/boolobject.h",
        "include/python3.9/bytearrayobject.h",
        "include/python3.9/bytesobject.h",
        "include/python3.9/cellobject.h",
        "include/python3.9/ceval.h",
        "include/python3.9/classobject.h",
        "include/python3.9/code.h",
        "include/python3.9/codecs.h",
        "include/python3.9/compile.h",
        "include/python3.9/complexobject.h",
        "include/python3.9/context.h",
        "include/python3.9/datetime.h",
        "include/python3.9/descrobject.h",
        "include/python3.9/dictobject.h",
        "include/python3.9/dynamic_annotations.h",
        "include/python3.9/enumobject.h",
        "include/python3.9/errcode.h",
        "include/python3.9/eval.h",
        "include/python3.9/exports.h",
        "include/python3.9/fileobject.h",
        "include/python3.9/fileutils.h",
        "include/python3.9/floatobject.h",
        "include/python3.9/frameobject.h",
        "include/python3.9/funcobject.h",
        "include/python3.9/genericaliasobject.h",
        "include/python3.9/genobject.h",
        "include/python3.9/graminit.h",
        "include/python3.9/grammar.h",
        "include/python3.9/import.h",
        "include/python3.9/interpreteridobject.h",
        "include/python3.9/intrcheck.h",
        "include/python3.9/iterobject.h",
        "include/python3.9/listobject.h",
        "include/python3.9/longintrepr.h",
        "include/python3.9/longobject.h",
        "include/python3.9/marshal.h",
        "include/python3.9/memoryobject.h",
        "include/python3.9/methodobject.h",
        "include/python3.9/modsupport.h",
        "include/python3.9/moduleobject.h",
        "include/python3.9/namespaceobject.h",
        "include/python3.9/node.h",
        "include/python3.9/object.h",
        "include/python3.9/objimpl.h",
        "include/python3.9/odictobject.h",
        "include/python3.9/opcode.h",
        "include/python3.9/osdefs.h",
        "include/python3.9/osmodule.h",
        "include/python3.9/parsetok.h",
        "include/python3.9/patchlevel.h",
        "include/python3.9/picklebufobject.h",
        "include/python3.9/py_curses.h",
        "include/python3.9/pyarena.h",
        "include/python3.9/pycapsule.h",
        "include/python3.9/pyconfig.h",
        "include/python3.9/pyctype.h",
        "include/python3.9/pydebug.h",
        "include/python3.9/pydtrace.h",
        "include/python3.9/pyerrors.h",
        "include/python3.9/pyexpat.h",
        "include/python3.9/pyfpe.h",
        "include/python3.9/pyframe.h",
        "include/python3.9/pyhash.h",
        "include/python3.9/pylifecycle.h",
        "include/python3.9/pymacconfig.h",
        "include/python3.9/pymacro.h",
        "include/python3.9/pymath.h",
        "include/python3.9/pymem.h",
        "include/python3.9/pyport.h",
        "include/python3.9/pystate.h",
        "include/python3.9/pystrcmp.h",
        "include/python3.9/pystrhex.h",
        "include/python3.9/pystrtod.h",
        "include/python3.9/Python-ast.h",
        "include/python3.9/Python.h",
        "include/python3.9/pythonrun.h",
        "include/python3.9/pythread.h",
        "include/python3.9/pytime.h",
        "include/python3.9/rangeobject.h",
        "include/python3.9/setobject.h",
        "include/python3.9/sliceobject.h",
        "include/python3.9/structmember.h",
        "include/python3.9/structseq.h",
        "include/python3.9/symtable.h",
        "include/python3.9/sysmodule.h",
        "include/python3.9/token.h",
        "include/python3.9/traceback.h",
        "include/python3.9/tracemalloc.h",
        "include/python3.9/tupleobject.h",
        "include/python3.9/typeslots.h",
        "include/python3.9/ucnhash.h",
        "include/python3.9/unicodeobject.h",
        "include/python3.9/warnings.h",
        "include/python3.9/weakrefobject.h",
        "include/python3.9/cpython/abstract.h",
        "include/python3.9/cpython/bytearrayobject.h",
        "include/python3.9/cpython/bytesobject.h",
        "include/python3.9/cpython/ceval.h",
        "include/python3.9/cpython/code.h",
        "include/python3.9/cpython/dictobject.h",
        "include/python3.9/cpython/fileobject.h",
        "include/python3.9/cpython/fileutils.h",
        "include/python3.9/cpython/frameobject.h",
        "include/python3.9/cpython/import.h",
        "include/python3.9/cpython/initconfig.h",
        "include/python3.9/cpython/interpreteridobject.h",
        "include/python3.9/cpython/listobject.h",
        "include/python3.9/cpython/methodobject.h",
        "include/python3.9/cpython/object.h",
        "include/python3.9/cpython/objimpl.h",
        "include/python3.9/cpython/pyerrors.h",
        "include/python3.9/cpython/pylifecycle.h",
        "include/python3.9/cpython/pymem.h",
        "include/python3.9/cpython/pystate.h",
        "include/python3.9/cpython/sysmodule.h",
        "include/python3.9/cpython/traceback.h",
        "include/python3.9/cpython/tupleobject.h",
        "include/python3.9/cpython/unicodeobject.h",
        "include/python3.9/internal/pegen_interface.h",
        "include/python3.9/internal/pycore_abstract.h",
        "include/python3.9/internal/pycore_accu.h",
        "include/python3.9/internal/pycore_atomic.h",
        "include/python3.9/internal/pycore_bytes_methods.h",
        "include/python3.9/internal/pycore_byteswap.h",
        "include/python3.9/internal/pycore_call.h",
        "include/python3.9/internal/pycore_ceval.h",
        "include/python3.9/internal/pycore_code.h",
        "include/python3.9/internal/pycore_condvar.h",
        "include/python3.9/internal/pycore_context.h",
        "include/python3.9/internal/pycore_dtoa.h",
        "include/python3.9/internal/pycore_fileutils.h",
        "include/python3.9/internal/pycore_gc.h",
        "include/python3.9/internal/pycore_getopt.h",
        "include/python3.9/internal/pycore_gil.h",
        "include/python3.9/internal/pycore_hamt.h",
        "include/python3.9/internal/pycore_hashtable.h",
        "include/python3.9/internal/pycore_import.h",
        "include/python3.9/internal/pycore_initconfig.h",
        "include/python3.9/internal/pycore_interp.h",
        "include/python3.9/internal/pycore_object.h",
        "include/python3.9/internal/pycore_pathconfig.h",
        "include/python3.9/internal/pycore_pyerrors.h",
        "include/python3.9/internal/pycore_pyhash.h",
        "include/python3.9/internal/pycore_pylifecycle.h",
        "include/python3.9/internal/pycore_pymem.h",
        "include/python3.9/internal/pycore_pystate.h",
        "include/python3.9/internal/pycore_runtime.h",
        "include/python3.9/internal/pycore_sysmodule.h",
        "include/python3.9/internal/pycore_traceback.h",
        "include/python3.9/internal/pycore_tupleobject.h",
        "include/python3.9/internal/pycore_warnings.h",
    ],
    cmd = """
        OUT_DIR=$$PWD/$(@D)
        rm -rf $$OUT_DIR
        mkdir $$OUT_DIR
        #
        cd external/python
        INSTALL_DIR=$$PWD/out
        #
        ./configure \
            --prefix=$$OUT_DIR \
            --exec_prefix=$$OUT_DIR \
            --enable-loadable-sqlite-extensions \
            --enable-optimizations
        make && make install
        #
        if ! $$OUT_DIR/bin/python3 -c "import ssl"
        then
            echo "ERROR: Python was built *WITHOUT* the SSL module. This will break PyPI downloads. Please re-run this script after installing libssl-dev (see the README)."
            exit 1
        fi
        if ! $$OUT_DIR/bin/python3 -c "import zlib"
        then
            echo "ERROR: Python was built *WITHOUT* the zlib module. If needed, please re-run this script after installing zlib1g-dev (see the README)."
            exit 1
        fi
    """,
    visibility = ["//visibility:public"],
)

cc_library(
    name = "python",
    srcs = glob(["lib/*.a"]) + [":build_python"],
    hdrs = glob([
        "include/**/*.h",
        "include/**/**/*.h",
    ]),
    includes = ["include/python3.9"],
    linkstatic = 1,
    visibility = ["//visibility:public"],
)
